<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ØªÙˆÙ„Ø¯ Ù…Ø´ØªØ±ÛŒØ§Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.1.0/dist/jalaali.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, set, get, push, child, onValue
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyApghhs_DMICj5mvR8UkqHw-Cs63Ft8pCk",
      authDomain: "tavalod-moshtari.firebaseapp.com",
      databaseURL: "https://tavalod-moshtari-default-rtdb.firebaseio.com",
      projectId: "tavalod-moshtari",
      storageBucket: "tavalod-moshtari.firebasestorage.app",
      messagingSenderId: "405360346824",
      appId: "1:405360346824:web:5c66b7ac983b2ac3a487fd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.getTodayJalali = () => {
      const g = new Date();
      const j = window.jalaali.toJalaali(g);
      return {
        full: `${j.jy}/${String(j.jm).padStart(2, '0')}/${String(j.jd).padStart(2, '0')}`,
        key: `${j.jy}-${j.jm}-${j.jd}`,
        year: j.jy,
        month: j.jm,
        day: j.jd
      };
    };

    window.saveCongrats = async (id) => {
      const today = getTodayJalali();
      await set(ref(db, `congratulated/${today.key}/${id}`), true);
    };

    window.checkCongrats = async (id) => {
      const today = getTodayJalali();
      const snapshot = await get(ref(db, `congratulated/${today.key}/${id}`));
      return snapshot.exists();
    };

    window.firebaseApp = app;
    window.firebaseDB = db;
    window.firebaseRef = ref;
    window.firebasePush = push;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebaseGet = get;
    window.firebaseChild = child;
  </script>

  <style>
    body { font-family: sans-serif; }
    .birthday-today {
      background-color: #fee2e2;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #futureToggleBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #1e3a8a;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      text-align: center;
      line-height: 40px;
      cursor: pointer;
      z-index: 999;
    }
    #futureBirthdaysPanel {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 20px;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      z-index: 998;
    }
  </style>
</head>
<body class="p-4 bg-gray-50">
  <h1 class="text-2xl font-bold mb-6 text-indigo-700">ğŸ‚ ØªÙˆÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h1>

  <!-- Ù†Ù…Ø§ÛŒØ´ ØªÙˆÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² -->
  <div id="todayBirthdays"></div>

  <!-- Ø¢ÛŒÚ©ÙˆÙ† 7 Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„Ø¯Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ -->
  <div id="futureToggleBtn">7</div>

  <!-- Ù¾Ù†Ù„ ØªÙˆÙ„Ø¯Ù‡Ø§ÛŒ Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ -->
  <div id="futureBirthdaysPanel">
    <h2 class="font-bold mb-2">ğŸ ØªÙˆÙ„Ø¯Ù‡Ø§ÛŒ Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</h2>
    <div id="futureBirthdays"></div>
  </div>
  <script type="module">
    const today = getTodayJalali();
    const db = window.firebaseDB;
    const ref = window.firebaseRef;
    const get = window.firebaseGet;
    const push = window.firebasePush;
    const onValue = window.firebaseOnValue;
    const checkCongrats = window.checkCongrats;
    const saveCongrats = window.saveCongrats;

    const todayDiv = document.getElementById('todayBirthdays');
    const futureDiv = document.getElementById('futureBirthdays');
    const customersRef = ref(db, 'customers');

    onValue(customersRef, (snapshot) => {
      const data = snapshot.val();
      todayDiv.innerHTML = '';
      futureDiv.innerHTML = '';

      for (let id in data) {
        const customer = data[id];
        const [y, m, d] = customer.birth.split('/').map(x => parseInt(x));
        const isToday = (m === today.month && d === today.day);
        const dayDiff = d - today.day;

        if (m === today.month && dayDiff > 0 && dayDiff <= 7) {
          const div = document.createElement('div');
          div.className = 'border-b border-gray-200 py-2';
          div.textContent = `${customer.name} - ${customer.birth}`;
          futureDiv.appendChild(div);
        }

        if (isToday) {
          const div = document.createElement('div');
          div.className = 'birthday-today';
          const info = document.createElement('span');
          info.innerHTML = `<strong>${customer.name}</strong> - ${customer.birth}`;
          const btn = document.createElement('button');
          btn.className = 'bg-green-600 text-white px-3 py-1 rounded text-sm';
          btn.textContent = 'ğŸ‰ ØªØ¨Ø±ÛŒÚ© Ø¨Ú¯Ùˆ';
          btn.disabled = true;
          checkCongrats(id).then(already => {
            if (already) {
              btn.textContent = 'âœ… ØªØ¨Ø±ÛŒÚ© Ú¯ÙØªÙ‡ Ø´Ø¯';
              btn.disabled = true;
            } else {
              btn.disabled = false;
              btn.addEventListener('click', async () => {
                await saveCongrats(id);
                btn.textContent = 'âœ… ØªØ¨Ø±ÛŒÚ© Ú¯ÙØªÙ‡ Ø´Ø¯';
                btn.disabled = true;
              });
            }
          });

          div.appendChild(info);
          div.appendChild(btn);
          todayDiv.appendChild(div);
        }
      }
    });

    // Ú©Ù†ØªØ±Ù„ Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ù¾Ù†Ù„ ØªÙˆÙ„Ø¯Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡
    document.getElementById('futureToggleBtn').addEventListener('click', () => {
      const panel = document.getElementById('futureBirthdaysPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    });
  </script>
  <hr class="my-8">
  <h2 class="text-lg font-bold text-indigo-700 mb-4">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
  <form id="addCustomerForm" class="space-y-4 max-w-md">
    <input type="text" id="name" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" required class="w-full border p-2 rounded">
    <input type="text" id="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required class="w-full border p-2 rounded">
    <input type="text" id="birth" placeholder="ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ù…Ø«Ù„Ø§Ù‹ 1403/03/10)" required class="w-full border p-2 rounded">
    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">Ø«Ø¨Øª Ù…Ø´ØªØ±ÛŒ</button>
  </form>
  <script type="module">
    const addForm = document.getElementById("addCustomerForm");
    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const birth = document.getElementById("birth").value.trim();

      if (!name || !phone || !birth) {
        alert("Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.");
        return;
      }

      const newCustomer = { name, phone, birth };
      await push(ref(db, "customers"), newCustomer);
      alert("âœ… Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
      addForm.reset();
    });
  </script>
</body>
</html>
